<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gerenciamento de Usuários</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .usuarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .usuario-card {
            background: var(--cor-card);
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--sombra);
            border-left: 5px solid #3498db;
            transition: all 0.3s;
        }
        
        .usuario-card.administrador { border-left-color: #e74c3c; }
        .usuario-card.engenharia { border-left-color: #2ecc71; }
        .usuario-card.supervisor { border-left-color: #f39c12; }
        .usuario-card.manutencao { border-left-color: #9b59b6; }
        .usuario-card.operador { border-left-color: #3498db; }
        
        .usuario-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .usuario-acoes {
            display: flex;
            gap: 10px;
        }
        
        .btn-icone {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--cor-fundo-secundario);
            border: 1px solid var(--cor-borda);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-icone:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra);
        }
        
        .btn-icone.editar:hover { background: #3498db; color: white; }
        .btn-icone.excluir:hover { background: #e74c3c; color: white; }
        .btn-icone.bloquear:hover { background: #f39c12; color: white; }
        
        .usuario-info {
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .badge-nivel {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            color: white;
        }
        
        .badge-ativo {
            background: #2ecc71;
        }
        
        .badge-inativo {
            background: #95a5a6;
        }
        
        .filtros-usuarios {
            background: var(--cor-card);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--sombra);
        }
        
        .filtros-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filtro-group {
            flex: 1;
            min-width: 200px;
        }
        
        .acoes-em-lote {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <script>
        // Verificar se é administrador
        (function() {
            const nivel = localStorage.getItem('gestao_equipamentos_nivel');
            if (nivel !== 'administrador') {
                alert('Acesso negado. Apenas administradores podem acessar esta página.');
                window.location.href = 'index.html';
            }
        })();
    </script>
    
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-users-cog"></i> Gerenciamento de Usuários</h1>
            <div>
                <button onclick="window.location.href='index.html'" class="btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
                <button onclick="abrirModalNovoUsuario()" class="btn-primary">
                    <i class="fas fa-user-plus"></i> Novo Usuário
                </button>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="filtros-usuarios">
            <h3><i class="fas fa-filter"></i> Filtros</h3>
            <div class="filtros-row">
                <div class="filtro-group">
                    <label for="filtro-nivel">Nível de Acesso:</label>
                    <select id="filtro-nivel">
                        <option value="all">Todos os níveis</option>
                        <option value="administrador">Administrador</option>
                        <option value="engenharia">Engenharia</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="manutencao">Manutenção</option>
                        <option value="operador">Operador</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="filtro-status">Status:</label>
                    <select id="filtro-status">
                        <option value="all">Todos</option>
                        <option value="ativo">Ativos</option>
                        <option value="inativo">Inativos</option>
                    </select>
                </div>
                
                <div class="filtro-group">
                    <label for="filtro-busca">Buscar:</label>
                    <input type="text" id="filtro-busca" placeholder="Nome, usuário ou e-mail...">
                </div>
                
                <div class="filtro-group">
                    <label style="visibility: hidden;">.</label>
                    <button onclick="aplicarFiltros()" class="btn-secondary">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
            </div>
            
            <div class="acoes-em-lote">
                <button onclick="exportarUsuarios()" class="btn-small">
                    <i class="fas fa-file-export"></i> Exportar Lista
                </button>
                <button onclick="reenviarSenhas()" class="btn-small">
                    <i class="fas fa-envelope"></i> Reenviar Acesso
                </button>
            </div>
        </div>
        
        <!-- Grid de Usuários -->
        <div class="usuarios-grid" id="usuarios-container">
            <!-- Usuários serão carregados aqui -->
            <div class="loading">
                <i class="fas fa-cog fa-spin"></i>
                <p>Carregando usuários...</p>
            </div>
        </div>
        
        <!-- Estatísticas -->
        <div class="stats-bar">
            <div class="stat">
                <span class="stat-value" id="total-usuarios">0</span>
                <span class="stat-label">Total de Usuários</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="usuarios-ativos">0</span>
                <span class="stat-label">Usuários Ativos</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="ultimo-acesso">0</span>
                <span class="stat-label">Último Login (h)</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="admins-total">0</span>
                <span class="stat-label">Administradores</span>
            </div>
        </div>
    </div>
    
    <!-- Modal Novo/Editar Usuário -->
    <div id="modal-usuario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-usuario-titulo">Novo Usuário</h3>
                <span class="close-modal" onclick="fecharModalUsuario()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="form-usuario" onsubmit="salvarUsuario(event)">
                    <input type="hidden" id="usuario-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="usuario-nome">Nome Completo *</label>
                            <input type="text" id="usuario-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="usuario-username">Nome de Usuário *</label>
                            <input type="text" id="usuario-username" required 
                                   pattern="[a-z0-9_]+" title="Apenas letras minúsculas, números e underscore">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="usuario-email">E-mail *</label>
                            <input type="email" id="usuario-email" required>
                        </div>
                        <div class="form-group">
                            <label for="usuario-departamento">Departamento</label>
                            <input type="text" id="usuario-departamento">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="usuario-nivel">Nível de Acesso *</label>
                            <select id="usuario-nivel" required>
                                <option value="">Selecione...</option>
                                <option value="operador">Operador</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="manutencao">Manutenção</option>
                                <option value="engenharia">Engenharia</option>
                                <option value="administrador">Administrador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="usuario-status">Status</label>
                            <select id="usuario-status">
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="usuario-senha">Senha *</label>
                            <input type="password" id="usuario-senha" required 
                                   minlength="6" 
                                   title="Mínimo 6 caracteres">
                        </div>
                        <div class="form-group">
                            <label for="usuario-confirmar-senha">Confirmar Senha *</label>
                            <input type="password" id="usuario-confirmar-senha" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Força da Senha:</label>
                        <div class="senha-strength">
                            <div class="strength-bar">
                                <div class="strength-fill" id="senha-strength-bar"></div>
                            </div>
                            <span class="strength-text" id="senha-strength-text">Fraca</span>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="fecharModalUsuario()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary">
                            Salvar Usuário
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script>
        // Configuração do Gerenciador de Usuários
        class GerenciadorUsuarios {
            constructor() {
                this.usuarios = [];
                this.usuarioEditando = null;
                this.filtros = {
                    nivel: 'all',
                    status: 'all',
                    busca: ''
                };
                this.init();
            }
            
            async init() {
                // Verificar permissão
                if (!this.verificarPermissaoAdmin()) return;
                
                // Carregar usuários
                await this.carregarUsuarios();
                
                // Configurar eventos
                this.configurarEventos();
                
                // Renderizar interface
                this.renderizarUsuarios();
                this.atualizarEstatisticas();
            }
            
            verificarPermissaoAdmin() {
                const nivel = localStorage.getItem('gestao_equipamentos_nivel');
                if (nivel !== 'administrador') {
                    alert('Acesso negado. Apenas administradores.');
                    window.location.href = 'index.html';
                    return false;
                }
                return true;
            }
            
            async carregarUsuarios() {
                try {
                    // Usar o bin específico para usuários
                    const response = await fetch(
                        `${JSONBIN_CONFIG.BIN_USUARIOS.BASE_URL}/${JSONBIN_CONFIG.BIN_USUARIOS.ID}/latest`,
                        { headers: JSONBIN_CONFIG.headers }
                    );
                    
                    if (!response.ok) throw new Error('Erro ao carregar usuários');
                    
                    const result = await response.json();
                    
                    if (result.record && result.record.usuarios) {
                        this.usuarios = result.record.usuarios;
                    } else {
                        // Dados iniciais se o bin estiver vazio
                        this.usuarios = [
                            {
                                id: 1,
                                username: 'administrador',
                                senha: 'admin789',
                                nivel: 'administrador',
                                nome: 'Administrador Sistema',
                                email: 'admin@empresa.com',
                                departamento: 'TI',
                                ativo: true,
                                dataCriacao: new Date().toISOString().split('T')[0],
                                criadoPor: 'sistema'
                            }
                        ];
                    }
                    
                } catch (error) {
                    console.error('Erro ao carregar usuários:', error);
                    this.mostrarMensagem('Erro ao carregar usuários', 'error');
                }
            }
            
            async salvarUsuarios() {
                try {
                    const data = {
                        usuarios: this.usuarios,
                        nextUserId: this.usuarios.length > 0 ? 
                            Math.max(...this.usuarios.map(u => u.id)) + 1 : 1
                    };
                    
                    const response = await fetch(
                        `${JSONBIN_CONFIG.BIN_USUARIOS.BASE_URL}/${JSONBIN_CONFIG.BIN_USUARIOS.ID}`,
                        {
                            method: 'PUT',
                            headers: JSONBIN_CONFIG.headers,
                            body: JSON.stringify(data)
                        }
                    );
                    
                    if (!response.ok) throw new Error('Erro ao salvar usuários');
                    
                    return true;
                } catch (error) {
                    console.error('Erro ao salvar usuários:', error);
                    this.mostrarMensagem('Erro ao salvar usuários', 'error');
                    return false;
                }
            }
            
            configurarEventos() {
                // Eventos de filtro
                document.getElementById('filtro-nivel').addEventListener('change', (e) => {
                    this.filtros.nivel = e.target.value;
                    this.renderizarUsuarios();
                });
                
                document.getElementById('filtro-status').addEventListener('change', (e) => {
                    this.filtros.status = e.target.value;
                    this.renderizarUsuarios();
                });
                
                document.getElementById('filtro-busca').addEventListener('input', (e) => {
                    this.filtros.busca = e.target.value.toLowerCase();
                    this.renderizarUsuarios();
                });
                
                // Validação de senha em tempo real
                document.getElementById('usuario-senha')?.addEventListener('input', (e) => {
                    this.validarForcaSenha(e.target.value);
                });
                
                document.getElementById('usuario-confirmar-senha')?.addEventListener('input', (e) => {
                    this.validarConfirmacaoSenha();
                });
            }
            
            filtrarUsuarios() {
                return this.usuarios.filter(usuario => {
                    // Filtrar por nível
                    if (this.filtros.nivel !== 'all' && usuario.nivel !== this.filtros.nivel) {
                        return false;
                    }
                    
                    // Filtrar por status
                    if (this.filtros.status !== 'all') {
                        const isAtivo = usuario.ativo === true || usuario.ativo === undefined;
                        if (this.filtros.status === 'ativo' && !isAtivo) return false;
                        if (this.filtros.status === 'inativo' && isAtivo) return false;
                    }
                    
                    // Filtrar por busca
                    if (this.filtros.busca) {
                        const busca = this.filtros.busca;
                        const nomeMatch = usuario.nome.toLowerCase().includes(busca);
                        const usernameMatch = usuario.username.toLowerCase().includes(busca);
                        const emailMatch = usuario.email.toLowerCase().includes(busca);
                        
                        if (!nomeMatch && !usernameMatch && !emailMatch) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }
            
            renderizarUsuarios() {
                const container = document.getElementById('usuarios-container');
                const usuariosFiltrados = this.filtrarUsuarios();
                
                if (usuariosFiltrados.length === 0) {
                    container.innerHTML = `
                        <div class="no-results" style="grid-column: 1 / -1;">
                            <i class="fas fa-user-slash"></i>
                            <h3>Nenhum usuário encontrado</h3>
                            <p>Tente ajustar os filtros</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = usuariosFiltrados.map(usuario => {
                    const corNivel = PERMISSOES.getCorNivel(usuario.nivel);
                    const nomeNivel = PERMISSOES.getNomeNivel(usuario.nivel);
                    const iconeNivel = PERMISSOES.getIconeNivel(usuario.nivel);
                    const isAtivo = usuario.ativo === true || usuario.ativo === undefined;
                    
                    return `
                        <div class="usuario-card ${usuario.nivel}">
                            <div class="usuario-header">
                                <div>
                                    <h4>${usuario.nome}</h4>
                                    <div class="info-item">
                                        <i class="fas ${iconeNivel}" style="color: ${corNivel};"></i>
                                        <span>${nomeNivel}</span>
                                        <span class="badge-nivel ${isAtivo ? 'badge-ativo' : 'badge-inativo'}">
                                            ${isAtivo ? 'Ativo' : 'Inativo'}
                                        </span>
                                    </div>
                                </div>
                                <div class="usuario-acoes">
                                    <button class="btn-icone editar" onclick="gerenciador.editarUsuario(${usuario.id})" 
                                            title="Editar usuário">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icone bloquear" onclick="gerenciador.toggleStatusUsuario(${usuario.id})" 
                                            title="${isAtivo ? 'Desativar' : 'Ativar'} usuário">
                                        <i class="fas ${isAtivo ? 'fa-user-slash' : 'fa-user-check'}"></i>
                                    </button>
                                    <button class="btn-icone excluir" onclick="gerenciador.excluirUsuario(${usuario.id})" 
                                            title="Excluir usuário">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="usuario-info">
                                <div class="info-item">
                                    <i class="fas fa-user"></i>
                                    <strong>Usuário:</strong> ${usuario.username}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-envelope"></i>
                                    <strong>E-mail:</strong> ${usuario.email}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-building"></i>
                                    <strong>Departamento:</strong> ${usuario.departamento || 'Não informado'}
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-calendar"></i>
                                    <strong>Criado em:</strong> ${this.formatarData(usuario.dataCriacao)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            atualizarEstatisticas() {
                const totalUsuarios = this.usuarios.length;
                const usuariosAtivos = this.usuarios.filter(u => u.ativo === true || u.ativo === undefined).length;
                const adminsTotal = this.usuarios.filter(u => u.nivel === 'administrador').length;
                
                document.getElementById('total-usuarios').textContent = totalUsuarios;
                document.getElementById('usuarios-ativos').textContent = usuariosAtivos;
                document.getElementById('admins-total').textContent = adminsTotal;
            }
            
            async salvarUsuario(event) {
                event.preventDefault();
                
                const form = document.getElementById('form-usuario');
                const usuarioId = document.getElementById('usuario-id').value;
                const isEdit = !!usuarioId;
                
                // Validar senhas
                const senha = document.getElementById('usuario-senha').value;
                const confirmarSenha = document.getElementById('usuario-confirmar-senha').value;
                
                if (senha !== confirmarSenha) {
                    this.mostrarMensagem('As senhas não coincidem', 'error');
                    return;
                }
                
                // Verificar força da senha
                const forcaSenha = this.validarForcaSenha(senha);
                if (forcaSenha.nivel === 'fraca') {
                    if (!confirm('A senha é considerada fraca. Deseja continuar?')) {
                        return;
                    }
                }
                
                const usuario = {
                    username: document.getElementById('usuario-username').value.trim(),
                    nome: document.getElementById('usuario-nome').value.trim(),
                    email: document.getElementById('usuario-email').value.trim(),
                    departamento: document.getElementById('usuario-departamento').value.trim(),
                    nivel: document.getElementById('usuario-nivel').value,
                    ativo: document.getElementById('usuario-status').value === 'ativo',
                    senha: senha  // Em produção, isso seria criptografado!
                };
                
                // Validações
                if (!usuario.username || !usuario.nome || !usuario.email || !usuario.nivel) {
                    this.mostrarMensagem('Preencha todos os campos obrigatórios', 'error');
                    return;
                }
                
                // Verificar se username já existe (exceto no modo edição)
                if (!isEdit) {
                    const usernameExistente = this.usuarios.find(u => 
                        u.username.toLowerCase() === usuario.username.toLowerCase()
                    );
                    if (usernameExistente) {
                        this.mostrarMensagem('Nome de usuário já existe', 'error');
                        return;
                    }
                }
                
                if (isEdit) {
                    // Editar usuário existente
                    const index = this.usuarios.findIndex(u => u.id === parseInt(usuarioId));
                    if (index !== -1) {
                        usuario.id = parseInt(usuarioId);
                        usuario.dataCriacao = this.usuarios[index].dataCriacao;
                        usuario.criadoPor = this.usuarios[index].criadoPor;
                        this.usuarios[index] = usuario;
                    }
                } else {
                    // Criar novo usuário
                    usuario.id = this.usuarios.length > 0 ? 
                        Math.max(...this.usuarios.map(u => u.id)) + 1 : 1;
                    usuario.dataCriacao = new Date().toISOString().split('T')[0];
                    usuario.criadoPor = localStorage.getItem('gestao_equipamentos_usuario') || 'administrador';
                    this.usuarios.push(usuario);
                }
                
                // Salvar no JSONBin
                const salvou = await this.salvarUsuarios();
                if (salvou) {
                    this.mostrarMensagem(
                        isEdit ? 'Usuário atualizado com sucesso!' : 'Usuário criado com sucesso!',
                        'success'
                    );
                    
                    // Fechar modal e atualizar lista
                    this.fecharModalUsuario();
                    this.renderizarUsuarios();
                    this.atualizarEstatisticas();
                }
            }
            
            abrirModalNovoUsuario() {
                this.usuarioEditando = null;
                const modal = document.getElementById('modal-usuario');
                const titulo = document.getElementById('modal-usuario-titulo');
                const form = document.getElementById('form-usuario');
                
                titulo.textContent = 'Novo Usuário';
                form.reset();
                document.getElementById('usuario-id').value = '';
                
                // Resetar validação de senha
                document.getElementById('senha-strength-bar').style.width = '0%';
                document.getElementById('senha-strength-text').textContent = 'Fraca';
                
                modal.classList.add('active');
            }
            
            editarUsuario(id) {
                const usuario = this.usuarios.find(u => u.id === id);
                if (!usuario) return;
                
                this.usuarioEditando = usuario;
                const modal = document.getElementById('modal-usuario');
                const titulo = document.getElementById('modal-usuario-titulo');
                const form = document.getElementById('form-usuario');
                
                titulo.textContent = 'Editar Usuário';
                
                // Preencher formulário
                document.getElementById('usuario-id').value = usuario.id;
                document.getElementById('usuario-username').value = usuario.username;
                document.getElementById('usuario-nome').value = usuario.nome;
                document.getElementById('usuario-email').value = usuario.email;
                document.getElementById('usuario-departamento').value = usuario.departamento || '';
                document.getElementById('usuario-nivel').value = usuario.nivel;
                document.getElementById('usuario-status').value = 
                    (usuario.ativo === true || usuario.ativo === undefined) ? 'ativo' : 'inativo';
                
                // Senha em branco (não mostrar a atual por segurança)
                document.getElementById('usuario-senha').value = '';
                document.getElementById('usuario-confirmar-senha').value = '';
                document.getElementById('usuario-senha').placeholder = 'Deixe em branco para não alterar';
                document.getElementById('usuario-senha').removeAttribute('required');
                document.getElementById('usuario-confirmar-senha').removeAttribute('required');
                
                modal.classList.add('active');
            }
            
            fecharModalUsuario() {
                const modal = document.getElementById('modal-usuario');
                modal.classList.remove('active');
                
                // Resetar validação de senha
                document.getElementById('usuario-senha').setAttribute('required', 'true');
                document.getElementById('usuario-confirmar-senha').setAttribute('required', 'true');
                document.getElementById('usuario-senha').placeholder = '';
            }
            
            async excluirUsuario(id) {
                if (id === 1) {
                    this.mostrarMensagem('Não é possível excluir o usuário administrador principal', 'error');
                    return;
                }
                
                const usuario = this.usuarios.find(u => u.id === id);
                if (!usuario) return;
                
                const confirmar = confirm(`Tem certeza que deseja excluir o usuário "${usuario.nome}"?`);
                if (!confirmar) return;
                
                this.usuarios = this.usuarios.filter(u => u.id !== id);
                const salvou = await this.salvarUsuarios();
                
                if (salvou) {
                    this.mostrarMensagem('Usuário excluído com sucesso', 'success');
                    this.renderizarUsuarios();
                    this.atualizarEstatisticas();
                }
            }
            
            async toggleStatusUsuario(id) {
                if (id === 1) {
                    this.mostrarMensagem('Não é possível desativar o administrador principal', 'error');
                    return;
                }
                
                const usuario = this.usuarios.find(u => u.id === id);
                if (!usuario) return;
                
                const isAtivo = usuario.ativo === true || usuario.ativo === undefined;
                const acao = isAtivo ? 'desativar' : 'ativar';
                
                const confirmar = confirm(`Tem certeza que deseja ${acao} o usuário "${usuario.nome}"?`);
                if (!confirmar) return;
                
                usuario.ativo = !isAtivo;
                const salvou = await this.salvarUsuarios();
                
                if (salvou) {
                    this.mostrarMensagem(
                        `Usuário ${acao === 'desativar' ? 'desativado' : 'ativado'} com sucesso`,
                        'success'
                    );
                    this.renderizarUsuarios();
                    this.atualizarEstatisticas();
                }
            }
            
            validarForcaSenha(senha) {
                const forca = {
                    pontos: 0,
                    nivel: 'fraca'
                };
                
                if (!senha) return forca;
                
                // Verificar comprimento
                if (senha.length >= 6) forca.pontos++;
                if (senha.length >= 8) forca.pontos++;
                if (senha.length >= 12) forca.pontos++;
                
                // Verificar caracteres
                if (/[A-Z]/.test(senha)) forca.pontos++;
                if (/[a-z]/.test(senha)) forca.pontos++;
                if (/[0-9]/.test(senha)) forca.pontos++;
                if (/[^A-Za-z0-9]/.test(senha)) forca.pontos++;
                
                // Determinar nível
                if (forca.pontos <= 2) forca.nivel = 'fraca';
                else if (forca.pontos <= 4) forca.nivel = 'média';
                else if (forca.pontos <= 6) forca.nivel = 'forte';
                else forca.nivel = 'muito forte';
                
                // Atualizar interface
                const bar = document.getElementById('senha-strength-bar');
                const text = document.getElementById('senha-strength-text');
                
                if (bar && text) {
                    const porcentagem = (forca.pontos / 7) * 100;
                    bar.style.width = `${porcentagem}%`;
                    
                    // Cores baseadas na força
                    if (forca.nivel === 'fraca') {
                        bar.style.backgroundColor = '#e74c3c';
                    } else if (forca.nivel === 'média') {
                        bar.style.backgroundColor = '#f39c12';
                    } else if (forca.nivel === 'forte') {
                        bar.style.backgroundColor = '#2ecc71';
                    } else {
                        bar.style.backgroundColor = '#27ae60';
                    }
                    
                    text.textContent = forca.nivel.charAt(0).toUpperCase() + forca.nivel.slice(1);
                }
                
                return forca;
            }
            
            validarConfirmacaoSenha() {
                const senha = document.getElementById('usuario-senha').value;
                const confirmar = document.getElementById('usuario-confirmar-senha').value;
                const confirmarInput = document.getElementById('usuario-confirmar-senha');
                
                if (confirmar && senha !== confirmar) {
                    confirmarInput.style.borderColor = '#e74c3c';
                } else {
                    confirmarInput.style.borderColor = '';
                }
            }
            
            formatarData(dataString) {
                if (!dataString) return 'Não informada';
                try {
                    const data = new Date(dataString);
                    return data.toLocaleDateString('pt-BR');
                } catch (e) {
                    return dataString;
                }
            }
            
            mostrarMensagem(texto, tipo) {
                const mensagem = document.createElement('div');
                mensagem.className = `mensagem-flutuante ${tipo}`;
                mensagem.innerHTML = `
                    <div class="mensagem-conteudo">
                        <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                        <span>${texto}</span>
                    </div>
                `;
                
                document.body.appendChild(mensagem);
                
                setTimeout(() => {
                    mensagem.classList.add('show');
                }, 10);
                
                setTimeout(() => {
                    mensagem.classList.remove('show');
                    setTimeout(() => mensagem.remove(), 300);
                }, 5000);
            }
            
            async exportarUsuarios() {
                try {
                    let csv = 'ID,Usuário,Nome,E-mail,Departamento,Nível de Acesso,Status,Data Criação\n';
                    
                    this.usuarios.forEach(usuario => {
                        const escapeCSV = (str) => {
                            if (str === null || str === undefined) return '';
                            const string = String(str);
                            if (string.includes(',') || string.includes('"') || string.includes('\n')) {
                                return `"${string.replace(/"/g, '""')}"`;
                            }
                            return string;
                        };
                        
                        const isAtivo = usuario.ativo === true || usuario.ativo === undefined;
                        
                        csv += [
                            usuario.id,
                            escapeCSV(usuario.username),
                            escapeCSV(usuario.nome),
                            escapeCSV(usuario.email),
                            escapeCSV(usuario.departamento || ''),
                            escapeCSV(PERMISSOES.getNomeNivel(usuario.nivel)),
                            isAtivo ? 'Ativo' : 'Inativo',
                            usuario.dataCriacao || ''
                        ].join(',') + '\n';
                    });
                    
                    // Criar e baixar arquivo
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    
                    link.href = URL.createObjectURL(blob);
                    link.download = `usuarios_${new Date().toISOString().split('T')[0]}.csv`;
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.mostrarMensagem('Lista de usuários exportada com sucesso', 'success');
                    
                } catch (error) {
                    console.error('Erro ao exportar usuários:', error);
                    this.mostrarMensagem('Erro ao exportar lista', 'error');
                }
            }
        }
        
        // Inicializar gerenciador
        let gerenciador;
        document.addEventListener('DOMContentLoaded', () => {
            gerenciador = new GerenciadorUsuarios();
            window.gerenciador = gerenciador;
        });
        
        // Funções globais para acesso dos botões
        function abrirModalNovoUsuario() {
            gerenciador?.abrirModalNovoUsuario();
        }
        
        function fecharModalUsuario() {
            gerenciador?.fecharModalUsuario();
        }
        
        function aplicarFiltros() {
            // Filtros já são aplicados automaticamente via eventos
        }
        
        function exportarUsuarios() {
            gerenciador?.exportarUsuarios();
        }
        
        function reenviarSenhas() {
            alert('Funcionalidade de reenvio de senhas em desenvolvimento');
        }
    </script>
</body>
</html>
